<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>nBang</title>
  <link rel="search" type="application/opensearchdescription+xml" title="Local Search" href="opensearch.xml">
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      background-color: #333333;
      color: #ffffff;
    }
    .search-container {
      display: flex;
      gap: 8px;
      width: 500px;
      padding: 16px;
      border-radius: 8px;
      position: relative;
    }
    .search-input {
      padding: 8px;
      width: 500px;
      font-size: 16px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    .search-button, .options-button {
      padding: 8px 16px;
      font-size: 16px;
      cursor: pointer;
      border: 1px solid #ccc;
      border-radius: 4px;
      background-color: #f0f0f0;
    }
    .search-button:hover, .options-button:hover {
      background-color: #e0e0e0;
    }
    .options-menu {
      display: none;
      position: absolute;
      top: 100%;
      right: 0;
      background-color: #444444;
      color: #ffffff;
      border: 1px solid #555;
      border-radius: 4px;
      padding: 8px;
      z-index: 10;
    }
    .options-menu label {
      display: block;
      margin-bottom: 5px;
    }
    .reset-button {
      margin-top: 8px;
      padding: 8px;
      cursor: pointer;
      border: 1px solid #ccc;
      border-radius: 4px;
      background-color: #f0f0f0;
    }
    @media only screen and (max-width: 600px) {
      .search-container {
        flex-direction: column;
        padding: 10px;
        max-width: 85%;
      }
      .search-input, .search-button {
        width: 100%;
        padding: 10px;
        font-size: 14px;
        box-sizing: border-box;
      }
    }
  </style>
</head>
<body>
  <div class="search-container">
    <input id="searchInput" class="search-input" type="text" placeholder="Type your search query or !bang search" />
    <button id="searchBtn" class="search-button">Search</button>
    <button id="optionsBtn" class="options-button">Options</button>
    <div id="optionsMenu" class="options-menu">
      <div>
        <label for="fallbackSearch">Fallback Search Engine:</label>
        <select id="fallbackSearch">
          <option value="g">Google</option>
          <option value="d">DuckDuckGo</option>
          <option value="b">Bing</option>
          <option value="brave">Brave</option>
        </select>
      </div>
      <button id="resetButton" class="reset-button">Reset to Default</button>
    </div>
  </div>

  <script>
    // Definição de bangs
    const bangs = [
      { t: "a", u: "https://www.amazon.com.br/s?k={{{s}}}", d: "https://www.amazon.com.br" },
      { t: "ai", u: "https://www.duckduckgo.com/?q={{{s}}}&ia=chat&bang=true", d: "https://www.duckduckgo.com" },
      { t: "b", u: "https://www.bing.com/search?q={{{s}}}", d: "https://www.bing.com" },
      { t: "brave", u: "https://search.brave.com/search?q={{{s}}}", d: "https://search.brave.com" },
      { t: "claude", u: "https://claude.ai/search?q={{{s}}}", d: "https://claude.ai" },
      { t: "d", u: "https://duckduckgo.com/?q={{{s}}}", d: "https://duckduckgo.com" },
      { t: "g", u: "https://www.google.com.br/search?q={{{s}}}", d: "https://www.google.com.br" },
      { t: "gd", u: "https://drive.google.com/drive/search?q={{{s}}}", d: "https://drive.google.com" },
      { t: "i", u: "https://shopping.inter.co/busca?q={{{s}}}&tab=affiliate", d: "https://shopping.inter.co" },
      { t: "ig", u: "https://www.instagram.com/explore/search/keyword/?q={{{s}}}", d: "https://www.instagram.com" },
      { t: "j", u: "https://icasei.atlassian.net/browse/{{{s}}}", d: "https://home.atlassian.com" },
      { t: "l", u: "https://lucky.surf/{{{s}}}", d: "https://lucky.surf" },
      { t: "m", u: "https://maps.google.com/maps?q={{{s}}}", d: "https://maps.google.com" },
      { t: "o", u: "https://chat.openai.com/?q={{{s}}}", d: "https://chat.openai.com" },
      { t: "p", u: "https://www.promobit.com.br/busca?q={{{s}}}", d: "https://www.promobit.com.br" },
      { t: "pp", u: "https://www.perplexity.ai/search?q={{{s}}}", d: "https://www.perplexity.ai" },
      { t: "r", u: "https://www.reddit.com/search?q={{{s}}}", d: "https://www.reddit.com" },
      { t: "y", u: "https://www.youtube.com/results?search_query={{{s}}}", d: "https://www.youtube.com" },
    ];

    // Inicialização
    let fallbackEngine = localStorage.getItem('fallbackSearchEngine') || 'ddg';
    const searchInput = document.getElementById('searchInput');
    const searchBtn = document.getElementById('searchBtn');
    const optionsBtn = document.getElementById('optionsBtn');
    const optionsMenu = document.getElementById('optionsMenu');
    const fallbackSearch = document.getElementById('fallbackSearch');
    const resetButton = document.getElementById('resetButton');

    // Definir valor do dropdown a partir do localStorage
    fallbackSearch.value = fallbackEngine;

    // Função de busca
    function handleSearch(query) {
      if (!query) return;

      const match = query.match(/!(\S+)/i);
      if (!match) {
        // Sem bang, usa o motor de busca fallback
        const fallbackBang = bangs.find(b => b.t === fallbackEngine);
        if (fallbackBang) {
          window.location.replace(fallbackBang.u.replace('{{{s}}}', encodeURIComponent(query)));
        }
        return;
      }

      const bangCode = match[1].toLowerCase();
      const cleanQuery = query.replace(/!\S+\s*/i, '').trim();

      // Verificar se o bang existe
      const selectedBang = bangs.find(b => b.t === bangCode);
      if (selectedBang) {
        // Se a consulta estiver vazia, redireciona para a homepage
        if (cleanQuery === '') {
          window.location.replace(selectedBang.d);
        } else {
          window.location.replace(selectedBang.u.replace('{{{s}}}', encodeURIComponent(cleanQuery).replace(/%2F/g, '/')));
        }
        return;
      }

      // Se o bang não for reconhecido, usa o motor de busca fallback
      const fallbackBang = bangs.find(b => b.t === fallbackEngine);
      if (fallbackBang) {
        window.location.replace(fallbackBang.u.replace('{{{s}}}', encodeURIComponent(cleanQuery || bangCode)));
      }
    }

    // Event Listeners
    window.onload = function() {
      searchInput.focus();
    };

    // Alternar visibilidade do menu de opções
    optionsBtn.onclick = function() {
      optionsMenu.style.display = optionsMenu.style.display === 'block' ? 'none' : 'block';
    };

    // Fechar menu de opções ao clicar fora
    document.addEventListener('click', (event) => {
      if (!optionsMenu.contains(event.target) && event.target !== optionsBtn) {
        optionsMenu.style.display = 'none';
      }
    });

    // Atualizar motor de busca fallback
    fallbackSearch.onchange = function() {
      fallbackEngine = this.value;
      localStorage.setItem('fallbackSearchEngine', fallbackEngine);
    };

    // Resetar para configurações padrão
    resetButton.onclick = function() {
      localStorage.clear();
      fallbackSearch.value = 'b';
      fallbackEngine = 'b';
      searchInput.value = '';
      searchInput.focus();
    };

    // Preview de sugestões
    const input = document.getElementById('searchInput');
    const previewBox = document.createElement('div');
    previewBox.id = 'bangPreview';
    previewBox.style.position = 'absolute';
    previewBox.style.top = '100%';
    previewBox.style.left = '0';
    previewBox.style.width = '100%';
    previewBox.style.background = '#333333';
    previewBox.style.border = '1px solid #ccc';
    previewBox.style.zIndex = '1000';
    previewBox.style.display = 'none';
    previewBox.style.maxHeight = '200px';
    previewBox.style.overflowY = 'auto';
    input.parentNode.appendChild(previewBox);

    let highlightedIndex = -1;
    let currentMatches = [];

    input.addEventListener('input', function() {
      const value = input.value.trim();
      if (value.startsWith('!')) {
        const query = value.slice(1).toLowerCase();
        currentMatches = bangs.filter(b => b.t.startsWith(query));
        highlightedIndex = -1; // Reset ao digitar
        if (currentMatches.length > 0) {
          renderPreview();
          previewBox.style.display = 'block';
        } else {
          previewBox.style.display = 'none';
        }
      } else {
        previewBox.style.display = 'none';
      }
    });

    function renderPreview() {
      previewBox.innerHTML = currentMatches.map((b, i) =>
        `<div style="padding: 8px; cursor: pointer; background:${i === highlightedIndex ? '#555' : 'none'}"
          class="${i === highlightedIndex ? 'highlighted' : ''}"
          data-index="${i}"
          onclick="document.getElementById('searchInput').value='!${b.t} ';document.getElementById('bangPreview').style.display='none';">!${b.t} — ${b.d}</div>`
      ).join('');
    }

    // Esconde o preview ao perder o foco
    input.addEventListener('blur', function() {
      setTimeout(() => { previewBox.style.display = 'none'; }, 200);
    });

    // Listener ÚNICO para navegação, seleção e busca
    input.addEventListener('keydown', function(e) {
      if (previewBox.style.display === 'block' && currentMatches.length > 0) {
        if (e.key === 'ArrowDown') {
          e.preventDefault();
          highlightedIndex = (highlightedIndex + 1) % currentMatches.length;
          renderPreview();
          return;
        } else if (e.key === 'ArrowUp') {
          e.preventDefault();
          highlightedIndex = (highlightedIndex - 1 + currentMatches.length) % currentMatches.length;
          renderPreview();
          return;
        } else if (e.key === 'Tab' || e.key === 'Enter') {
          if (highlightedIndex >= 0) {
            e.preventDefault();
            input.value = '!' + currentMatches[highlightedIndex].t + ' ';
            previewBox.style.display = 'none';
            return; // Não ativa a busca!
          }
        }
      }
      // Só ativa a busca se o preview não está aberto ou não há sugestão destacada
      if (e.key === 'Enter') {
        handleSearch(input.value.trim());
      }
    });

    // Clique no botão de busca
    searchBtn.addEventListener('click', () => handleSearch(searchInput.value.trim()));

    // Lidar com parâmetros de URL
    const urlParams = new URLSearchParams(window.location.search);
    const initialQuery = urlParams.get('q');
    if (initialQuery) {
      searchInput.value = initialQuery;
      handleSearch(initialQuery);
    }
  </script>
</body>
</html>
