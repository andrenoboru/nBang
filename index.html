<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>nBang</title>
  <link rel="search" type="application/opensearchdescription+xml" title="Local Search" href="opensearch.xml">
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      background-color: #2a2a35;
      color: #e8e8e8;
    }
    
    .search-container {
      display: flex;
      gap: 8px;
      width: 500px;
      padding: 16px;
      border-radius: 8px;
      position: relative;
    }
    
    .search-input {
      padding: 8px;
      width: 500px;
      font-size: 16px;
      border: 1px solid #555;
      border-radius: 4px;
      background-color: #3a3a45;
      color: #e8e8e8;
      transition: opacity 0.2s;
    }
    
    .search-button {
      padding: 8px 16px;
      font-size: 16px;
      cursor: pointer;
      border: 1px solid #555;
      border-radius: 4px;
      background-color: #4a4a55;
      color: #e8e8e8;
      transition: background-color 0.2s;
      position: relative;
      overflow: hidden;
      min-width: 70px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .search-button:hover:not(.loading) {
      background-color: #5a5a65;
    }
    
    .search-button.loading {
      background-color: #4a4a55;
      cursor: not-allowed;
    }
    
    .button-text {
      transition: opacity 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .search-button.loading .button-text {
      opacity: 0;
    }
    
    .loading-spinner {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 16px;
      height: 16px;
      border: 2px solid #555;
      border-top: 2px solid #e8e8e8;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      opacity: 0;
      transition: opacity 0.2s ease;
    }
    
    .search-button.loading .loading-spinner {
      opacity: 1;
    }
    
    @keyframes spin {
      0% { transform: translate(-50%, -50%) rotate(0deg); }
      100% { transform: translate(-50%, -50%) rotate(360deg); }
    }
    
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(42, 42, 53, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.2s ease;
    }
    
    .loading-overlay.active {
      opacity: 1;
      visibility: visible;
    }
    
    .loading-spinner-large {
      width: 40px;
      height: 40px;
      border: 3px solid #555;
      border-top: 3px solid #e8e8e8;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    .bang-preview {
      position: absolute;
      top: 100%;
      left: 0;
      width: 100%;
      background: #3a3a45;
      border: 1px solid #555;
      border-radius: 0 0 4px 4px;
      z-index: 1000;
      max-height: 200px;
      overflow-y: auto;
      display: none;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    }
    
    .preview-item {
      padding: 8px 12px;
      cursor: pointer;
      transition: background-color 0.1s;
      line-height: 1.4;
    }
    
    .preview-item strong {
      color: #ffffff;
      font-weight: bold;
    }
    
    .preview-item:hover, .preview-item.highlighted {
      background-color: #4a4a55;
    }
    
    .domain-name {
      color: #9a9aa5;
      font-size: 0.9em;
    }
    
    @media only screen and (max-width: 600px) {
      .search-container {
        flex-direction: column;
        padding: 10px;
        max-width: 85%;
        width: 100%;
      }
      
      .search-input, .search-button {
        width: 100%;
        padding: 10px;
        font-size: 14px;
        box-sizing: border-box;
      }
    }
  </style>
</head>
<body>
  <div class="search-container">
    <input id="searchInput" class="search-input" type="text" placeholder="Type your search query or !bang search" />
    <button id="searchBtn" class="search-button">
      <span class="button-text">Search</span>
      <div class="loading-spinner"></div>
    </button>
    <div id="bangPreview" class="bang-preview"></div>
  </div>

  <div id="loadingOverlay" class="loading-overlay">
    <div class="loading-spinner-large"></div>
  </div>

  <script>
    // Array de bangs únicos (estrutura original)
    const bangs = [
      { t: ["a", "amazon", "amazonbr"], u: "https://amazon.com.br/s?k={{{s}}}", d: "amazon.com.br" },
      { t: ["ai"], u: "https://duckduckgo.com/?q={{{s}}}&ia=chat&bang=true", d: "duckduckgo.com" },
      { t: ["b", "bing"], u: "https://bing.com/search?q={{{s}}}", d: "bing.com" },
      { t: ["c", "claude"], u: "https://claude.ai/new?q={{{s}}}", d: "claude.ai" },
      { t: ["d", "ddg", "duckduckgo"], u: "https://duckduckgo.com/?q={{{s}}}", d: "duckduckgo.com" },
      { t: ["g", "gbr", "google"], u: "https://google.com.br/search?q={{{s}}}", d: "google.com.br" },
      { t: ["gd","gdrive", "drive"], u: "https://drive.google.com/drive/search?q={{{s}}}", d: "drive.google.com" },
      { t: ["i", "inter"], u: "https://shopping.inter.co/busca?q={{{s}}}&tab=affiliate", d: "shopping.inter.co" },
      { t: ["ig", "instagram"], u: "https://instagram.com/explore/search/tags/?q={{{s}}}", d: "instagram.com" },
      { t: ["j","jira"], u: "https://icasei.atlassian.net/browse/{{{s}}}", d: "icasei.atlassian.net" },
      { t: ["l","lucky"], u: "http://duckduckgo.com/?q=!+{{{s}}}", d: "duckduckgo.com" },
      { t: ["m","maps"], u: "https://maps.google.com/maps?q={{{s}}}", d: "maps.google.com" },
      { t: ["o","chatgpt"], u: "https://chat.openai.com/?q={{{s}}}", d: "chat.openai.com" },
      { t: ["p", "pp"], u: "https://perplexity.ai/search?q={{{s}}}", d: "perplexity.ai" },
      { t: ["pb", "promobit"], u: "https://promobit.com.br/buscar?q={{{s}}}", d: "promobit.com.br" },
      { t: ["r","reddit"], u: "https://reddit.com/search?q={{{s}}}", d: "reddit.com" },
      { t: ["s","shopee"], u: "https://shopee.com.br/search?keyword={{{s}}}", d: "shopee.com.br" },
      { t: ["y","yt", "youtube"], u: "https://youtube.com/results?search_query={{{s}}}", d: "youtube.com" },
    ];

    // Map para busca rápida O(1) - criado uma vez
    const bangMap = new Map();
    bangs.forEach(bang => {
      bang.t.forEach(trigger => {
        bangMap.set(trigger, bang);
      });
    });
    
    const fallbackBang = bangMap.get('b');
    
    const searchInput = document.getElementById('searchInput');
    const searchBtn = document.getElementById('searchBtn');
    const previewBox = document.getElementById('bangPreview');
    const loadingOverlay = document.getElementById('loadingOverlay');

    let highlightedIndex = -1;
    let currentMatches = [];
    let isLoading = false;

    // Debounce para otimizar performance do preview
    let debounceTimer;
    function debounce(func, wait) {
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(debounceTimer);
          func(...args);
        };
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(later, wait);
      };
    }

    // Cache para renderização do preview
    const previewCache = new Map();

    function showLoading() {
      if (isLoading) return;
      isLoading = true;
      searchBtn.classList.add('loading');
      searchInput.style.opacity = '0.7';
      loadingOverlay.classList.add('active');
      searchInput.disabled = true;
      previewBox.style.display = 'none';
    }

    function hideLoading() {
      isLoading = false;
      searchBtn.classList.remove('loading');
      searchInput.style.opacity = '1';
      loadingOverlay.classList.remove('active');
      searchInput.disabled = false;
    }

    function handleSearch(query) {
      if (!query || isLoading) return;

      showLoading();

      // Processamento imediato para URL params (sem delay)
      const isFromParams = window.location.search.includes('q=');
      const delay = isFromParams ? 0 : 150;

      setTimeout(() => {
        const match = query.match(/!(\S+)/i);
        if (!match) {
          // Sem bang, usa fallback
          if (fallbackBang) {
            window.location.replace(fallbackBang.u.replace('{{{s}}}', encodeURIComponent(query)));
          }
          return;
        }

        const bangCode = match[1].toLowerCase();
        const cleanQuery = query.replace(/!\S+\s*/i, '').trim();

        // Busca O(1) no Map
        const selectedBang = bangMap.get(bangCode);
        if (selectedBang) {
          if (cleanQuery === '') {
            window.location.replace("https://" + selectedBang.d);
          } else {
            window.location.replace(selectedBang.u.replace('{{{s}}}', encodeURIComponent(cleanQuery).replace(/%2F/g, '/')));
          }
          return;
        }

        // Fallback
        if (fallbackBang) {
          window.location.replace(fallbackBang.u.replace('{{{s}}}', encodeURIComponent(query)));
        }
      }, delay);
    }

    // Função otimizada para filtrar bangs
    function filterBangs(query) {
      const cacheKey = query;
      if (previewCache.has(cacheKey)) {
        return previewCache.get(cacheKey);
      }

      const matches = bangs.filter(b => 
        b.t.some(trigger => trigger.startsWith(query))
      );

      // Cache apenas para queries curtas (mais comuns)
      if (query.length <= 3) {
        previewCache.set(cacheKey, matches);
      }

      return matches;
    }

    // Preview otimizado com debounce
    const updatePreview = debounce(function() {
      if (isLoading) return;
      
      const value = searchInput.value.trim();
      if (value.startsWith('!')) {
        const query = value.slice(1).toLowerCase();
        
        currentMatches = filterBangs(query);
        highlightedIndex = -1;
        
        if (currentMatches.length > 0) {
          renderPreview();
          previewBox.style.display = 'block';
        } else {
          previewBox.style.display = 'none';
        }
      } else {
        previewBox.style.display = 'none';
      }
    }, 50);

    function renderPreview() {
      const query = searchInput.value.slice(1).toLowerCase();
      
      previewBox.innerHTML = currentMatches.map((b, i) => {
        const matchingTrigger = b.t.find(t => t.startsWith(query)) || b.t[0];
        const allTriggers = b.t.map(trigger => 
          trigger === matchingTrigger ? `<strong>!${trigger}</strong>` : `!${trigger}`
        ).join(', ');
        
        return `<div class="preview-item ${i === highlightedIndex ? 'highlighted' : ''}"
          data-index="${i}" 
          data-trigger="${matchingTrigger}"
          onclick="selectBang(this)">
          ${allTriggers} <span class="domain-name">— ${b.d}</span>
        </div>`;
      }).join('');
    }

    // Função global para selecionar bang
    window.selectBang = function(element) {
      const trigger = element.getAttribute('data-trigger');
      searchInput.value = '!' + trigger + ' ';
      previewBox.style.display = 'none';
      searchInput.focus();
    };

    // Event listeners otimizados
    searchInput.addEventListener('input', updatePreview);

    searchInput.addEventListener('blur', function() {
      setTimeout(() => { previewBox.style.display = 'none'; }, 200);
    });

    searchInput.addEventListener('keydown', function(e) {
      if (isLoading) {
        e.preventDefault();
        return;
      }
      
      if (previewBox.style.display === 'block' && currentMatches.length > 0) {
        if (e.key === 'ArrowDown') {
          e.preventDefault();
          highlightedIndex = (highlightedIndex + 1) % currentMatches.length;
          renderPreview();
          return;
        } else if (e.key === 'ArrowUp') {
          e.preventDefault();
          highlightedIndex = (highlightedIndex - 1 + currentMatches.length) % currentMatches.length;
          renderPreview();
          return;
        } else if (e.key === 'Tab' || e.key === 'Enter') {
          if (highlightedIndex >= 0) {
            e.preventDefault();
            const selectedTrigger = currentMatches[highlightedIndex].t[0];
            searchInput.value = '!' + selectedTrigger + ' ';
            previewBox.style.display = 'none';
            searchInput.focus();
            return;
          }
        }
      }
      
      if (e.key === 'Enter') {
        handleSearch(searchInput.value.trim());
      }
    });

    searchBtn.addEventListener('click', () => {
      if (!isLoading) {
        handleSearch(searchInput.value.trim());
      }
    });

    // Inicialização otimizada
    window.addEventListener('load', function() {
      // Prioriza parâmetros de URL
      const urlParams = new URLSearchParams(window.location.search);
      const initialQuery = urlParams.get('q');
      
      if (initialQuery) {
        searchInput.value = initialQuery;
        handleSearch(initialQuery);
      } else {
        searchInput.focus();
      }
    });

    // Previne comportamento padrão
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Enter' && e.target === searchInput) {
        e.preventDefault();
      }
    });
  </script>
</body>
</html>
